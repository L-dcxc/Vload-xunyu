# 电子负载上位机 - 通信对接测试指南

## 已完成功能

### 1. 核心通信层
- ✅ Transport 传输层（串口 + TCP）
- ✅ SCPI 协议客户端（命令发送/查询、日志记录）
- ✅ 设备业务层（ElectronicLoad，封装所有 SCPI 命令）
- ✅ 设备管理器（DeviceManager，协调 UI 和后台线程）

### 2. 已实现的 SCPI 命令
- 系统命令：`*IDN?`, `*RST`, `*CLS`, `SYST:REM/LOC/RWL`, `SYST:BEEP`, `SYST:SENS`
- 模式控制：`MODE` (CC/CV/CP/CR)
- 参数设定：`CURR`, `VOLT`, `POW`, `RES`
- 保护设置：`CURR:PROT`, `POW:PROT`, `VOLT:ON/OFF`
- 量程设置：`CURR:RANG`, `VOLT:RANG`
- 测量命令：`MEAS:VOLT?`, `MEAS:CURR?`, `MEAS:POW?`, `MEAS:RES?`
- 输入控制：`INPUT ON/OFF`

### 3. UI 功能
- ✅ 串口/TCP 连接选择
- ✅ 连接/断开控制
- ✅ 实时测量数据显示（V/I/P/R）
- ✅ 曲线实时绘制
- ✅ 模式切换（CC/CV/CP/CR）
- ✅ 参数下发（设定值、OCP、OPP）
- ✅ START/STOP/紧急停止
- ✅ 通信日志记录（TX/RX/ERR）
- ✅ SCPI 终端（手工发送命令）

## 测试步骤

### 1. 安装依赖
```bash
pip install -r requirements.txt
```

### 2. 串口连接测试
1. 在"方式"下拉框选择 `COM`
2. 界面会自动切换到串口配置：
   - **COM 口下拉框**：显示所有可用串口（如 COM3 (USB Serial Port)）
   - **波特率下拉框**：选择波特率（默认 115200）
   - **刷新按钮**：点击可重新扫描串口列表
3. 选择正确的 COM 口和波特率
4. 点击"连接"按钮
5. 观察：
   - 顶部状态栏应显示"已连接"（绿灯）
   - 设备信息应显示 `*IDN?` 返回的内容
   - 运行日志应显示连接成功信息
   - 通信日志应显示 TX/RX 记录

### 3. TCP 连接测试
1. 在"方式"下拉框选择 `TCP`
2. 界面会自动切换到 TCP 配置：
   - **地址输入框**：输入 `192.168.1.50:5025`（根据实际 IP 调整）
3. 点击"连接"按钮
4. 观察同上

### 4. 功能测试

#### 4.1 模式切换
1. 连接设备后，点击"恒流(CC)"、"恒压(CV)"等按钮
2. 观察运行日志，应显示模式切换成功

#### 4.2 参数下发
1. 在"设定值"输入框输入：`1.5`
2. 在"过流保护"输入框输入：`10`
3. 点击"下发参数"按钮
4. 观察运行日志，应显示参数设置成功

#### 4.3 启停控制
1. 点击"START"按钮，设备应开始带载（`INPUT ON`）
2. 观察实时监控区域，电压/电流/功率/内阻应开始更新
3. 观察曲线图，应开始绘制 V/I/P 曲线
4. 点击"STOP"按钮，设备应停止带载（`INPUT OFF`）

#### 4.4 SCPI 终端测试
1. 切换到"数据与日志"页 → "SCPI 终端" Tab
2. 输入命令：`*IDN?`，点击"发送"
3. 应显示设备返回的信息
4. 尝试其他命令：
   - `MODE?` - 查询当前模式
   - `CURR?` - 查询电流设定值
   - `MEAS:VOLT?` - 查询电压测量值

#### 4.5 通信日志查看
1. 切换到"数据与日志"页 → "通信日志" Tab
2. 应看到所有 TX（发送）和 RX（接收）的原始报文
3. 格式：`[时间戳] TX: 命令` 或 `[时间戳] RX: 响应`

## 常见问题

### 1. 串口连接失败
- 点击"刷新"按钮重新扫描串口列表
- 检查串口是否被其他程序占用（关闭串口助手等工具）
- 检查 USB 线缆连接是否正常
- 尝试不同的波特率（常见：9600, 115200）
- 在设备管理器中确认串口驱动已正确安装

### 2. TCP 连接失败
- 检查 IP 地址和端口是否正确
- 检查网络连接是否正常
- 检查设备是否开启了 TCP 服务

### 3. 测量数据不更新
- 检查设备是否已启动（点击 START）
- 检查通信日志是否有错误
- 尝试断开重连

### 4. 命令执行失败
- 查看通信日志中的错误信息
- 参考 `电子负载SCPI指令集.md` 确认命令格式
- 在 SCPI 终端手工测试命令

## 下一步开发计划

- [ ] 添加更多高级功能（DYN/LIST/OCP/Timing）
- [ ] 数据导出功能（CSV/Excel）
- [ ] 任务序列执行
- [ ] 自动重连机制
- [ ] 参数范围校验
- [ ] 更完善的错误处理

## 运行程序

```bash
python -m app
```
