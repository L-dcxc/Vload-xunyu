# 电子负载上位机（PyQt + SCPI）开发计划

## 1. 项目目标

- 支持电子负载的 SCPI 控制与测量
- 支持两种通信方式（二选一连接，UI 内可切换）：
  - 串口（COM，RS232/虚拟串口）
  - TCP（LAN Socket）
- 提供基础控制、模式配置、保护设置、测量监控、调试日志等核心能力
- 架构上将“通信/协议/业务/UI”分层，方便后续扩展 LIST/OCP/Timing 等高级功能

## 2. 范围说明（以现有 SCPI 文档为准）

协议基础约定：
- 下行/上行均为 ASCII
- 以换行符 `<NL>(0x0A)` 作为一帧结束
- 参数支持单位后缀（默认单位可省略）：V/mV、A/mA、W/mW、S/ms 等

SCPI 说明书文件：`电子负载SCPI指令集.md`

## 3. 总体架构设计（建议）

采用分层结构，避免 UI 直接拼 SCPI 字符串：

### 3.1 Transport（传输层）

职责：负责字节/行的收发、超时、连接管理。

接口建议：
- `open()` / `close()`
- `write_line(str)`：自动补 `\n`
- `read_line()`：读到 `\n` 或超时
- `is_open` / `timeout_ms`

实现：
- `TcpTransport`：`socket` 直连设备 IP:PORT
- `SerialTransport`：`pyserial` 打开 COM 口

### 3.2 SCPI Client（协议层）

职责：提供 `send/query`，统一处理 `\n`、锁（防并发串包）、日志记录。

接口建议：
- `send(cmd: str) -> None`
- `query(cmd: str) -> str`

注意点：
- 同一时刻只允许一个 `query` 在飞行（互斥锁）
- 记录 TX/RX 原始报文（调试必备）
- 将超时/IO 错误包装成统一异常类型，UI 可提示并可重连

### 3.3 Device Model（设备业务层）

职责：把 SCPI 命令映射成方法，并做参数/返回值解析。

建议模块：
- `system`：`*IDN?`、`*RST`、`*CLS`、`SYST:REM/LOC/RWL`、`SYST:BEEP`、`SYST:SENS`
- `range_protect`：`CURR:RANG`、`VOLT:RANG`、`CURR:PROT`、`POW:PROT`、`VOLT:ON/OFF`、SLEW
- `mode_setpoint`：`MODE/FUNC`、`CURR/VOLT/POW/RES`
- `measure`：`MEAS:*?`（平均/峰值/谷值/峰峰值）
- `advanced`（后续扩展）：DYN / LED / LIST / OCP / Timing / LoadEffect

### 3.4 UI（PyQt）

- 用 Qt 的信号槽把后台任务（轮询测量/发送命令）和 UI 解耦
- 后台线程/任务负责轮询 `MEAS:*?`，避免阻塞主线程
- 单独的“SCPI 终端/日志”页用于手工发送/查看原始 TX/RX

## 4. MVP 功能（第一版必须交付）

### 4.1 连接与通信

- 通信方式选择：`COM` / `TCP`
- 串口：COM 口选择、波特率等参数（提供默认值，可高级设置）
- TCP：IP、端口、超时设置
- 连接/断开、连接状态提示
- `*IDN?` 识别并展示设备信息
- 原始通讯日志窗口（可清空、可保存）

### 4.2 基础控制

- `*RST` 复位
- `*CLS` 清除
- 远程/本地：`SYST:REM` / `SYST:LOC` / `SYST:RWL`
- 蜂鸣器：`SYST:BEEP:STAT`
- 远端补偿：`SYST:SENS`

### 4.3 模式与设定

- 模式切换：CC/CV/CP/CR（先做这四个）
- 设定值输入：
  - CC：`CURR <value>`
  - CV：`VOLT <value>`
  - CP：`POW <value>`
  - CR：`RES <value>`
- 基本输入校验（非数字、负数、空值拦截）

### 4.4 量程与保护

- 电流档位：`CURR:RANG`
- 电压档位：`VOLT:RANG`
- OCP/OPP：`CURR:PROT`、`POW:PROT`
- Von/Voff：`VOLT:ON`、`VOLT:OFF`
- SLEW：`CURR:SLEW`、`VOLT:SLEW`

### 4.5 测量监控

- 轮询刷新：电压/电流/功率/阻抗
- 可选：峰值/谷值/峰峰值显示
- 刷新频率可配置（例如 2Hz/5Hz/10Hz）

## 5. 第二阶段功能（增强/高级模式）

- DYN 动态模式：`DYN:HIGH/LOW`、`DWELL`、`SLEW`、`DYN:MODE`
- LED 模式：`LED:VOLT`、`LED:CURR`、`LED:RCO`
- LIST 模式：
  - 编辑电流序列/驻留时间/斜率：`LIST:CURR`、`LIST:DWELL`、`LIST:CURR:SLEW`
  - 执行次数：`LIST:COUNT`
  - 触发响应：`LIST:STEP`
  - 存取：`LIST:SAV` / `LIST:RCL`
  - 加载：`INIT:NAME LIST`
- OCP 测试：配置、启停、结果查询（`OCP:RES?`、`OCP:RES:PMAX?`）
- Timing 测试：配置、启停、结果查询（`TIM:RES?`）
- Load Effect：配置与结果查询

## 6. 第三阶段（工程化能力）

- SCPI 脚本/宏（录制与回放）
- 数据记录：CSV 导出，带时间戳
- 多设备同时连接（工位测试）
- 更完善的异常恢复：自动重连、命令重试策略、断线保护

## 7. 目录结构建议（Python）

建议在仓库根目录创建如下结构（后续落地时再逐步建立）：

- `app/`
  - `ui/`（PyQt 界面）
  - `core/`
    - `transport/`（tcp/serial）
    - `scpi/`（ScpiClient）
    - `device/`（ElectronicLoad 业务封装）
  - `main.py`
- `docs/`（可选）

## 8. 技术依赖建议

- PyQt：`PyQt6` 或 `PySide6`（二选一）
- 串口：`pyserial`
- TCP：标准库 `socket`

## 9. 关键风险与对策

- 通信串包/并发：SCPI Client 强制互斥，所有 `query` 串行化
- 超时与UI卡顿：测量轮询放到工作线程/任务中
- 参数范围不明确：先做“基础校验 + 设备端报错提示”，后续再补完整范围表

## 10. 里程碑与验收标准（建议）

### M0：连通性验证（0.5~1 天）
- 串口/TCP 任一方式连接成功
- `*IDN?` 可正常返回并显示
- SCPI 终端可手工发送并看到回包

### M1：MVP 可用版本（2~5 天）
- 完成 MVP 功能（第 4 章）
- 测量轮询稳定运行 30 分钟无卡死
- 日志可导出或至少可复制

### M2：高级模式（3~7 天）
- DYN/LIST/OCP/Timing 中至少完成 2 个模块

### M3：工程化（按需）
- 脚本/数据记录/多设备等
